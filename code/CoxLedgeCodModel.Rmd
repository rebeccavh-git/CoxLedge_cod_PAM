---
title: "CoxLedge_cod_model"
author: "Becca Van Hoeck"
date: "10/14/2021"
output: html_document
---
https://github.com/rebeccavh-git/CoxLedge_cod_PAM

Research Questions: 

1. Is the timing of Atlantic cod spawning-associated vocalization, including grunt presence and rate, associated with environmental variables? 
2. Do these environmental associations fall within the variation observed in Massachusetts Bay? 

Data Source:
- Fixed station passive acoustic monitoring data from spawning season of 2013 and 2014 at 1 site on Cox Ledge 
- Data are summarized by cod grunt presence and grunt rate per hour during the spawning season.
- Massachusetts Bay data spans 10 years and spawning associations are previously published


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages

```{r}

library(lunar)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(lme4)
library(lmtest)
library(pscl)
library(MuMIn)
library(emmeans)
library(circular)
library(doBy) # for summaryBy - can I use dplyr/ group_by instead?

```

# Load data

```{r}
cox = read.csv("data/codCoxModelData.csv", header = TRUE)

```

# Transform predictors to circular or quadratic

```{r}
cox$SpawnSeason = factor(cox$SpawnSeason)

# Hour of the day
cox$shour = sin(2*pi*(cox$hour/24)) 
cox$chour = cos(2*pi*(cox$hour/24)) 

# Julian Day
cox$sday = sin(2*pi*(cox$J/365))
cox$cday = cos(2*pi*(cox$J/365))

cox$daySq = cox$J_center^2

# Lunar cycle  
cox$sLunar = sin(cox$lunarphase) 
cox$cLunar = cos(cox$lunarphase)

#Semi lunar cycle
cox$sLunar2 = sin(cox$lunar2)
cox$cLunar2 = cos(cox$lunar2)


```

# Explore zeros

```{r}
mean(cox$n_grunts) # mean n_grunts = 0.18

cox %>% summarise(sum(n_grunts == 0)/n()) # 96.3% zeros

ggplot(cox, aes(x = n_grunts))+
  geom_bar()

max(cox$n_grunts)

# mean day of grunt presence
codPresence = cox[cox$presence == 1,]
meanDay = mean(codPresence$J)


```

# Mixture model: compare poisson with neg binomial of global mode

```{r}
### Global Model

# Zero-inflated Poisson: GLobal Model
Zip1 = zeroinfl(n_grunts ~ SpawnSeason + sday + cday + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + sday + cday + shour + chour + sLunar + cLunar + sLunar2 + cLunar2,
                  dist = "poisson", link = "logit", data = cox)
summary(Zip1)

# Zero-inflated negative binomial: Global Model
Zinb1 = zeroinfl(n_grunts ~ SpawnSeason + sday + cday + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + sday + cday + shour + chour + sLunar + cLunar + sLunar2 + cLunar2,
                  dist = "negbin", link = "logit", data = cox)
summary(Zinb1)

# Zero-inflated negative binomial: Global Model, day as quadratic

Zinbq = zeroinfl(n_grunts ~ SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2,
                  dist = "negbin", link = "logit", data = cox)
summary(Zinbq)

# likelihood ratio test between the poisson and neg bin models
# proceed with negative binomial 
lrtest(Zip1, Zinb1) 
AIC(Zip1, Zinb1, Zinbq)
```

## Moving forward with Negative Binomial - build candidate models

Caiger et al (Mass Bay paper): best models used as candidate models for Cox Ledge data set 
```{r}
### Candidate models: hypotheses based on Mass Bay results
 
# Global Model
globalMod = zeroinfl(n_grunts ~ SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2,
                  dist = "negbin", link = "logit", data = cox, na.action = na.fail)

# no lunar terms in zero process
Mod1 = zeroinfl(n_grunts ~ SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + J_center + daySq + shour + chour,
                  dist = "negbin", link = "logit", data = cox)

# Only L1 in zero process
Mod2 = zeroinfl(n_grunts ~ SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar,
                  dist = "negbin", link = "logit", data = cox)

# Only L2 in zero process
Mod3 = zeroinfl(n_grunts ~ SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + J_center + daySq + shour + chour + sLunar2 + cLunar2,
                  dist = "negbin", link = "logit", data = cox)

# Only L2 in count processes, no lunar in zero
Mod4 = zeroinfl(n_grunts ~ SpawnSeason + J_center + daySq + shour + chour + sLunar2 + cLunar2 |
                  SpawnSeason + J_center + daySq + shour + chour,
                  dist = "negbin", link = "logit", data = cox)

model.sel(globalMod, Mod1, Mod2, Mod3, Mod4)
# Mod 3 (only L2 in zero-process) has lowest AIC, delta is 10 to next best


```

# Final model summary & estimated marginal means

Questions: 
1. How to extract predictions & CI from the zero and count processes of the model with circular variables

```{r}
codMod = zeroinfl(n_grunts ~ SpawnSeason + J_center + daySq + shour + chour + sLunar + cLunar + sLunar2 + cLunar2 |
                  SpawnSeason + J_center + daySq + shour + chour + sLunar2 + cLunar2,
                  dist = "negbin", link = "logit", data = cox)
summary(codMod)

# Exploring options with emmeans functions

test_grid = ref_grid(codMod)

## Estimated marginal means
emm_year_pres = emmeans(codMod, ~ SpawnSeason, mode = "zero")
emm_year_rate = emmeans(codMod, ~ SpawnSeason, mode = "count")

plot(emm_year_pres)
plot(emm_year_rate)

emm_hour_pres = emmeans(codMod, ~shour+chour, mode = "zero")
emm_hour_rate = emmeans(codMod, ~shour+chour, mode = "count")

#emm_lunar_pres = emmeans(codMod, ~sLunar+cLunar, mode = "zero") # lunar not in zero process
emm_lunar_rate = emmeans(codMod, ~sLunar+cLunar, mode = "count")

emm_lunar2_pres = emmeans(codMod, ~ sLunar2+cLunar2, mode = "zero")
emm_lunar2_rate = emmeans(codMod, ~ sLunar2+cLunar2, mode = "count")
# does this show the expected change in rate, given 1 change in lunar2?
# does that make sense for circular?
plot(emm_lunar2_rate)


# emmmeans functions to try
# keep all unique values of percent
ref_grid(pigs.lm2, cov.keep = "percent")

testHour = ref_grid(codMod, cov.keep = c("shour","chour"), at = list(sLunar = ))
testEmmHour = emmeans(testHour, ~shour+chour, mode = "zero")


# set a grid of points to predict at
mtcars.rg <- ref_grid(mtcars.lm, cov.keep = 3,
                      at = list(disp = c(100, 200, 300)))
mtcars.rg



```

## Calculating emmeans following Micah's code
- doesn't work for the new quadratic day variables
- this manually makes reference grid and predicts on this grid, how do I get CI?

```{r}
# interpret how they calculated emmeans on circular variables. Set others to their mean and calculated effects?

# Micah's function to calculate circular variables from dataframe input
make_circ<-function(d){
    out<-d
    namez<-names(d)
    if("hour"%in%namez){
      out$shour<-sin(2*pi*(out$hour/24))
      out$chour<-cos(2*pi*(out$hour/24))
    }
    # if("day"%in%namez){  #original code for when model included circular day
    #   out$sday<-sin(2*pi*(out$day/365))
    #   out$cday<-cos(2*pi*(out$day/365))
    # }
    # if("day"%in%namez){  # my attempt to update this function for the circular variable (it didn't work)
    #   out$J_center<-out$J_center
    #   out$daysq<-out$J_center^2
    # }
    if("Lunar"%in%namez){
      out$sLunar<-sin(out$Lunar)
      out$cLunar<-cos(out$Lunar)
      out$Lunar2<-out$Lunar
      out$Lunar2[out$Lunar2>pi]<-out$Lunar2[out$Lunar2>pi]-pi
      out$Lunar2<-2*out$Lunar2
      out$sLunar2<-sin(out$Lunar2) #SEMI-LUNAR
      out$cLunar2<-cos(out$Lunar2) #SEMI-LUNAR
    }
    return(out)
  }

## Diel Estimated marginal means following Micah's code 
# Day = 309 (mean day of presence), Full moon
nHour = expand.grid(SpawnSeason=as.character(unique(cox$SpawnSeason)), J_center=-0.7321493, daySq=0.5360426, Lunar=pi, hour=0:23)
nHour = make_circ(nHour)
nHour$presence = predict(codMod, newdata=nHour, type='zero')
nHour$rate = predict(codMod, newdata=nHour, type='count') 
emm_h = summaryBy(cbind(presence,rate)~hour,data=nHour,FUN=mean,keep.names=TRUE)

## Lunar EMM
nLunar = expand.grid(SpawnSeason=as.character(unique(cox$SpawnSeason)), J_center=-0.7321493, daySq=0.5360426,
                    Lunar=seq(0,2*pi,length=16),hour=0)
nLunar = make_circ(nLunar)
nLunar$presence = predict(codMod, newdata=nLunar, type='zero')
nLunar$rate = predict(codMod, newdata=nLunar, type='count')
emm_l<-summaryBy(cbind(presence,rate)~Lunar,data=nLunar,FUN=mean,keep.names=TRUE) 

## Seasonal effect 
J_centerRange = unique(cox$J_center)
daySqRange = unique(cox$daySq)
nDay = expand.grid(SpawnSeason=as.character(unique(cox$SpawnSeason)),J_center=J_centerRange, daySq = daySqRange ,Lunar=pi,hour=0)
nDay = make_circ(nDay)
nDay$presence = predict(codMod, newdata=nDay, type='zero')
nDay$rate = predict(codMod, newdata=nDay, type='count')
emm_j<-summaryBy(cbind(presence,rate)~J_center,data=nDay,FUN=mean,keep.names=TRUE)

# my edits to make this dataframe work with the date range
# emm_j$month = c(rep(1,31),rep(10, 31), rep(11,30), rep(12,31))
# emm_j$date = c(1:31,1:31,1:30,1:31)
# emm_j$SSorder = emm_j$day
# emm_j$SSorder[1:31] = emm_j$SSorder[1:31]+365


```

## Plot EM Means with ggplot

```{r}

# Diel
ggplot(data=emm_h, aes(x=hour, y = presence))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Hour", breaks = c(6,12,18,24), labels = c("6", "12", "18","24"))+
  scale_y_continuous(name = "Grunt Presence")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

ggplot(data=emm_h, aes(x=hour, y = rate))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Hour", breaks = c(6,12,18,24), labels = c("6", "12", "18","24"))+
  scale_y_continuous(name = "Grunt Rate")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

#Lunar
# the rate association is weird
ggplot(data=emm_l, aes(x=Lunar, y = presence))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Lunar cycle", breaks = c(0,pi/2, pi, 3*pi/2),labels = c("New", "Waxing","Full","Waning"))+
  scale_y_continuous(name = "Grunt Presence")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

ggplot(data=emm_l, aes(x=Lunar, y = rate))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Lunar cycle", breaks = c(0,pi/2, pi, 3*pi/2),labels = c("New", "Waxing","Full","Waning"))+
  scale_y_continuous(name = "Grunt Rate")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

# Seasonal
ggplot(data=emm_j, aes(x=J_center, y = presence))+ theme_bw()+
  geom_line(size = 1)+
  #scale_x_continuous(name = "Month", breaks = c(274,305,335,366), labels = c("Oct", "Nov", "Dec","Jan"))+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

ggplot(data=emm_j, aes(x=J_center, y = rate))+ theme_bw()+
  geom_line(size = 1)+
  #scale_x_continuous(name = "Month", breaks = c(274,305,335,366), labels = c("Oct", "Nov", "Dec","Jan"))+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))


```

## Summarize mass bay variation/ find needed code from Micah's script

Code below calculates the EM means from the mass bay model and re-creates their figures from the publication
- once I know how to calculate confidence intervals around these EM means, I can make the comparison
```{r}

load("data/gsub.rdat")
load("data/pam_mixed_modz.rdat")
# recreate best mass bay model: presence
# BUT THIS WAS A MODEL AVERAGE? HOW TO GET THEIR OUTOUT

  #SELECT BEST MODELS FOR PLOTTING 
  bbest<-bmodz$b15
  zbest<-zmodz$z18

## Micah's Functions
  make_circ<-function(d){
    out<-d
    namez<-names(d)
    if("H"%in%namez){
      out$Hsin<-sin(2*pi*(out$H/24))
      out$Hcos<-cos(2*pi*(out$H/24))
    }
    if("J"%in%namez){
      out$Jsin<-sin(2*pi*(out$J/365))
      out$Jcos<-cos(2*pi*(out$J/365))
    }
    if("MOON"%in%namez){
      out$Msin<-sin(out$MOON)
      out$Mcos<-cos(out$MOON)
      out$MOON2<-out$MOON
      out$MOON2[out$MOON2>pi]<-out$MOON2[out$MOON2>pi]-pi
      out$MOON2<-2*out$MOON2
      out$Lsin<-sin(out$MOON2) #SEMI-LUNAR
      out$Lcos<-cos(out$MOON2) #SEMI-LUNAR
    }
    return(out)
  }
 
  
#EST MARGINAL MEANS
#MEAN ACROSS ALL YEARS & SITES, BUT AT MIDNIGHT, FULL MOON, NOV23
if(TRUE){

  #DIEL FX
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=335,MOON=pi,H=0:24,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  nd$pG<-predict(bbest,newdata=nd,type='response')
  nd$rG<-predict(zbest,newdata=nd,type='response')
  emm_h<-summaryBy(cbind(pG,rG)~H,data=nd,FUN=mean,keep.names=TRUE)
  
  ggplot(data=emm_h, aes(x=H, y = pG))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Hour", breaks = c(6,12,18,24), labels = c("6", "12", "18","24"))+
  scale_y_continuous(name = "Grunt Presence")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

ggplot(data=emm_h, aes(x=H, y = rG))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Hour", breaks = c(6,12,18,24), labels = c("6", "12", "18","24"))+
  scale_y_continuous(name = "Grunt Rate")+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))
  
  #LUNAR FX
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=335,MOON=seq(0,2*pi,length=16),H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  nd$pG<-predict(bbest,newdata=nd,type='response')
  nd$rG<-predict(zbest,newdata=nd,type='response')
  emm_l<-summaryBy(cbind(pG,rG)~MOON,data=nd,FUN=mean,keep.names=TRUE) 
  
  # These circular plots are very dependent on the y scale for interpretation 
  ggplot(data=emm_l, aes(x=MOON, y = pG))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Lunar cycle", breaks = c(0,pi/2, pi, 3*pi/2),labels = c("New", "Waxing","Full","Waning"))+
  scale_y_continuous(name = "Grunt Presence", limits = c(0.2,0.28))+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

ggplot(data=emm_l, aes(x=MOON, y = rG))+ theme_bw()+
  coord_polar(start = 0)+
  geom_line(size = 1)+
  scale_x_continuous(name = "Lunar cycle", breaks = c(0,pi/2, pi, 3*pi/2),labels = c("New", "Waxing","Full","Waning"))+
  scale_y_continuous(name = "Grunt Rate", limits = c(2,7))+
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))

  
  
  #ANNUAL FX - OVERALL
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=275:400,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  nd$pG<-predict(bbest,newdata=nd,type='response')
  nd$rG<-predict(zbest,newdata=nd,type='response')
  emm_j<-summaryBy(cbind(pG,rG)~J,data=nd,FUN=mean,keep.names=TRUE)
  emm_j$edate<-as.Date('2010-12-31')+emm_j$J
  less
  
  # this does not match their figs in the pub
  plot(emm_j$edate, emm_j$pG)
  plot(emm_j$edate, emm_j$rG)
  
  #ANNUAL x SITE FX
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=282:365,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  nd$pG<-predict(bbest,newdata=nd,type='response')
  nd$rG<-predict(zbest,newdata=nd,type='response')
  emm_js<-summaryBy(cbind(pG,rG)~J+Site,data=nd,FUN=mean,keep.names=TRUE)
  emm_js$edate<-as.Date('2010-12-31')+emm_js$J
  sitz<-unique(emm_js$Site)
  peakz<-NULL
  for(s in 1:length(sitz)){
    sub<-subset(emm_js,Site==sitz[s])
    pk_pG<-sub$edate[sub$pG==max(sub$pG)]
    pk_rG<-sub$edate[sub$rG==max(sub$rG)]
    df<-data.frame(Site=sitz[s],peak_pG=pk_pG,peak_rg=pk_rG)
    peakz<-rbind(peakz,df)
  }
  
  #SITE FX
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=282:365,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  nd$pG<-predict(bbest,newdata=nd,type='response')
  nd$rG<-predict(zbest,newdata=nd,type='response')
  emm_s<-summaryBy(cbind(pG,rG)~Site,data=nd,FUN=mean,keep.names=TRUE)
  
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=282:365,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  nd$pG<-predict(bbest,newdata=nd,type='response')
  nd$rG<-predict(zbest,newdata=nd,type='response')
  emm_y<-summaryBy(cbind(pG,rG)~Y,data=nd,FUN=mean,keep.names=TRUE)
  #emm_y<-summaryBy(pG~Y,data=nd,FUN=mean,keep.names=TRUE)
  emm_y$Y<-as.numeric(as.character(emm_y$Y))
  emm_y<-emm_y[order(emm_y$Y),]
  plot(pG~Y,data=emm_y,type='l')
  
  #emm_ys<-summaryBy(cbind(pG,rG)~Y+Site,data=nd,FUN=mean,keep.names=TRUE)
  emm_ys<-summaryBy(pG~Y+Site,data=nd,FUN=mean,keep.names=TRUE)
  emm_ys$Y<-as.numeric(as.character(emm_ys$Y))
  emm_ys<-emm_ys[order(emm_ys$Y),]
  
  sitz<-unique(emm_ys$Site)
  emm_ys$SiteY<-paste(emm_ys$Site,emm_ys$Y,sep="_")
  plot(pG~Y,data=emm_ys,col=Site,type='n')
  for(s in 1:length(sitz)){
    ltx<-ceiling(s/8)
    lines(pG~Y,data=emm_ys,subset=Site==sitz[s],col=alpha(s,0.33),lty=ltx)
    esub<-subset(emm_ys,SiteY%in%gsub$SiteY)
    lines(pG~Y,data=esub,subset=Site==sitz[s],col=s,lwd=2,lty=ltx)
  }
  legend("topleft",legend=sitz,col=1:length(sitz),cex=0.85,lty=ceiling((1:length(sitz))/8),lwd=2)
  
}

#GGPLOT FIGURE of DIEL, LUNAR FX
if(TRUE){
  alf<-0.5
  yfrac<-0.95
  ############

  ###########
  #PRESENCE
  ymn<-min(c(emm_h$pG,emm_l$pG))
  ymx<-max(c(emm_h$pG,emm_l$pG))
  yrange<-ymx-ymn
  ymn<-ymn-(yrange*0.25)
  ymx<-ymx+(yrange*0.25)

  #DIEL PRESENCE
  xmx<-24
  labz_h<-data.frame(H=c(23,5.5,11,16.5),lab=c("Night","","Day",""))
  colz_h<-rep("black",24); colz_h[7:16]<-"white"; colz_h[c(6,17)]<-"darkgray"; 
  pg_circ_h<-ggplot()+
      geom_rect(aes(xmin=0:23,xmax=1:24,ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_h,alf))+
      coord_polar()+geom_line(data=emm_h,aes(x=H,y=pG),lwd=2)+
      ylim(ymn,ymx)+theme_minimal()+
      theme(
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(hjust=0.5,vjust=1)
      ) +
      ggtitle("Grunt Presence")+
      geom_text(data=labz_h, aes(x=H, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
  pg_circ_h  
  
  #LUNAR PRESENCE
  seq_l<-seq(0,2*pi,length=32)
  crp_l<-colorRampPalette(c("black","white","black"))
  colz_l<-crp_l(length(seq_l)-1)
  labz_l<-data.frame(MOON=c(0,pi/2,pi,pi*1.5),lab=c("New Moon","","Full Moon",""))
  pg_circ_l<-ggplot()+geom_rect(aes(xmin=seq_l[-length(seq_l)],xmax=seq_l[-1],ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_l,alf))+
    coord_polar()+geom_line(data=emm_l,aes(x=MOON,y=pG),lwd=2)+ylim(ymn,ymx)+
    theme_minimal()+
    theme(
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      plot.title = element_text(hjust=0.5,vjust=1)
    ) +
    xlab("Lunar")+
    geom_text(data=labz_l, aes(x=MOON, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
  pg_circ_l
  
  ############
  #RATE
  ymn<-min(c(emm_h$rG,emm_l$rG))
  ymx<-max(c(emm_h$rG,emm_l$rG))
  yrange<-ymx-ymn
  ymn<-ymn-(yrange*0.25)
  ymx<-ymx+(yrange*0.25)
  
  #DIEL RATE
  labz_h<-data.frame(H=c(23,5.5,11,16.5),lab=c("Night","","Day",""))
  colz_h<-rep("black",24); colz_h[7:16]<-"white"; colz_h[c(6,17)]<-"darkgray"; 
  rg_circ_h<-ggplot()+
    geom_rect(aes(xmin=0:23,xmax=1:24,ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_h,alf))+
    coord_polar()+geom_line(data=emm_h,aes(H,rG),lwd=2)+ylim(ymn,ymx)+theme_minimal()+
    theme(
      axis.title.y=element_blank(),
      axis.title.x=element_blank(),
      axis.text.x = element_blank(),
      plot.title = element_text(hjust=0.5,vjust=1)
    ) +
    ggtitle("Grunt Rate")+
    geom_text(data=labz_h, aes(x=H, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
  rg_circ_h
  
  #LUNAR RATE
  seq_l<-seq(0,2*pi,length=32)
  crp_l<-colorRampPalette(c("black","white","black"))
  colz_l<-crp_l(length(seq_l)-1)
  labz_l<-data.frame(MOON=c(0,pi/2,pi,pi*1.5),lab=c("New Moon","","Full Moon",""))
  rg_circ_l<-ggplot()+geom_rect(aes(xmin=seq_l[-length(seq_l)],xmax=seq_l[-1],ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_l,alf))+
    coord_polar()+geom_line(data=emm_l,aes(x=MOON,y=rG),lwd=2)+ylim(ymn,ymx)+
    theme_minimal()+
    theme(
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      plot.title = element_text(hjust=0.5,vjust=1)
    ) +
    geom_text(data=labz_l, aes(x=MOON, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
  rg_circ_l
  
  grid.arrange(pg_circ_h,rg_circ_h,pg_circ_l,rg_circ_l,nrow=2)
  
  ht<-5 #HEIGHT OF PLOT IN INCHES
  nr<-2; nc<-2; lmat<-matrix(seq_len(nr*nc),nrow=nr,ncol=nc,byrow=TRUE)
  ggsave("diel_lunar_fx.jpg",marrangeGrob(list(pg_circ_h,rg_circ_h,pg_circ_l,rg_circ_l),layout_matrix=lmat,top="",padding=unit(0,"line")),width=ht*1,height=ht,dpi=600)
  
}

  

```

## Plot comparison of Cox Ledge and Mass Bay

```{r}



```

## Mass Bay model averaging code: function ictab not working

```{r}
## MICAH's FUNCTIONS

# calculate AIC/BIC for list of models
LIC<-function(x,crit="AIC"){
    if(crit=="AIC"){IC<-function(x,...)AIC(x,...)}
    if(crit=="BIC"){IC<-function(x,...)BIC(x,...)}
    out<-NULL
    for(i in 1:length(x)){
      ic<-try(IC(x[[i]]))
      this<-NA
      if(!'try-error'%in%class(ic))this<-ic
      out<-c(out,this)
    }
    return(out)
}

# Create table of AIC output for models
  ictab<-function(x){
    modz<-names(x)
    aicz<-LIC(x,crit="AIC")
    bicz<-LIC(x,crit="BIC")
    dfz<-unlist(lapply(x,FUN=edf))
    dfz<-round(unlist(lapply(x,FUN=edf)),3)
    daicz<-round(aicz-min(aicz,na.rm=TRUE),1)
    dbicz<-round(bicz-min(bicz,na.rm=TRUE),1)
    wa<-aicz; wa[is.na(wa)]<-Inf;   wa<-round(Weights(wa),3)
    wb<-bicz; wb[is.na(wb)]<-Inf;   wb<-round(Weights(wb),3)
    #de<-round(unlist(lapply(x,FUN=devexp)),1)
    df<-data.frame(mod=modz,wA=wa,wB=wb,dAIC=daicz,dBIC=dbicz,AIC=aicz,BIC=bicz,edf=dfz)
    rownames(df)<-NULL
    return(df)
  }
  
  #CALC EQUIVALENT DF FOR A GAM, GLM, etc
   edf<-function(x){
    isbad<-'try-error'%in%class(try(nobs(x),silent=TRUE))
    if(!isbad)return(nobs(x)-df.residual(x))
    if(isbad)return(NA)
   }
   
  #FUNCTION TO MAKE PREDICTIONS USING MODEL AVERAGING
  predict_multimod<-function(modz,weights=rep(1,length(modz)),newdata=NULL,type='response',se.fit=FALSE){
    out<-NULL
    for(m in modz){
      this<-predict(m,newdata=newdata,type=type,se.fit=se.fit)
      out<-cbind(out,this)
    }
    weights<-weights/sum(weights) #NORMALIZE TO SUM TO 1
    return(rowSums(t(t(out)*weights)))
  }
  
#SELECT BEST MODELS FOR PLOTTING 
  bbest<-bmodz$b15
  zbest<-zmodz$z18

 names(bmodz)<-paste("b",1:length(bmodz),sep="")
  btab<-ictab(bmodz)
  btab$mod<-names(bmodz)
  btab$form<-unlist(lapply(bmodz,function(x){unfun(x[["modelInfo"]]$allForm$formula)}))
  btab$loglik<-unlist(lapply(bmodz,logLik))
  btab$dup<-duplicated(btab[,-1])
  btab$CAND<-grepl("rW",btab$form)&!is.na(btab$AIC)&!btab$dup #A CANDIDATE MODEL FORM?
  btab$dAIC[btab$CAND]<-btab$AIC[btab$CAND]-min(btab$AIC[btab$CAND],na.rm=TRUE)
  btab$w<-round(exp(-0.5*btab$dAIC)/sum(exp(-0.5*btab$dAIC),na.rm=TRUE),4)
  btab$PRED<-btab$w>0.1&!is.na(btab$w)
  btab<-btab[order(-btab$CAND,btab$AIC),][c("mod","form","loglik","AIC","dAIC","w","df","PRED")]
  btab
  
  
  #####################
#Observed v Predicted 
bbest_mm<-bmodz[btab$mod[btab$PRED]]
zbest_mm<-zmodz[ztab$mod[ztab$PRED]]
bbest_wts<-btab$w[match(names(bbest_mm),btab$mod)]
zbest_wts<-ztab$w[match(names(zbest_mm),ztab$mod)]

#GRUNT PRESENCE
cx<-0.75
cxa<-1
lwx<-2
lwx_obs<-1.25
#jpeg(file="pred_v_obs_PRESENCE.jpg",width=6,height=4,units="in",res=600)
pdf(file="pred_v_obs_PRESENCE.pdf",width=6,height=4,colormodel="cmyk")
if(TRUE){
  clx_fit<-"black"
  #gsub$pred_GRUNTS<-predict(bbest,type='response')
  gsub$pred_GRUNTS<-predict_multimod(bbest_mm,weights=bbest_wts,type='response')
  msub<-unique(gsub[c("Site","Year")])
  sitez<-unique(subset(marus[order(-marus$LAT),],Site%in%as.character(unique(gsub$Site)))$Site)
  #sitez<-as.character(unique(gsub$Site))
  yrz<-sort(as.character(unique(gsub$Year)))
  xl<-c(282,365)
  d1<-as.Date('2015-01-01')
  d2<-as.Date('2015-12-01')
  dseq<-seq(d1,d2,by="month")
  jseq<-j2seq<-as.numeric(format(dseq,'%j'))
  j2seq[j2seq<100]<-j2seq[j2seq<100]+365
  mseq<-format(dseq,'%b')
  OND<-c(10:12)
  par(mfrow=c(length(sitez),length(yrz)),oma=c(3,3.5,3,4.5),mar=c(0,0,0,0),lend=2)
  for(s in 1:length(sitez)){
    sub<-subset(gsub,Site==sitez[s])
    sub$obs_GRUNTS<-as.numeric(sub$GRUNTS)
    ag_obs<-aggregate(obs_GRUNTS~J+MONTH+Year,data=sub,FUN=mean)
    ag_pred<-aggregate(pred_GRUNTS~J+MONTH+Year,data=sub,FUN=mean)
    max_obs<-max(ag_obs$obs_GRUNTS)
    max_pred<-max(ag_pred$pred_GRUNTS)
    ymax<-max(c(max_obs,max_pred))
    yl<-c(0,ymax)
    for(y in 1:length(yrz)){
      pred<-subset(gsub,Site==sitez[s]&Year==yrz[y])
      if(nrow(pred)==0){
        plot(1,type='n',axes=FALSE,ylim=yl,xlim=xl)
        rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "lightgray")
        box()
      }
      if(nrow(pred)>1){
        pred$obs_GRUNTS<-as.numeric(pred$GRUNTS)
        ag_obs<-aggregate(obs_GRUNTS~J+MONTH,data=pred,FUN=mean)
        ag_pred<-aggregate(pred_GRUNTS~J+MONTH,data=pred,FUN=mean)
        plot(obs_GRUNTS~J,data=ag_obs[order(ag_obs$J),],type='h',lwd=lwx_obs,col="gray",xlim=xl,yaxt='n',xaxt='n',ylim=yl)
        lines(pred_GRUNTS~J,data=ag_pred[order(ag_pred$J),],col=alpha(clx_fit,0.5),type='l',lwd=lwx)
      }
      if(s==length(sitez))axis(1,at=j2seq,labels=rep("",length(j2seq)),cex.axis=cx)
      if(s==length(sitez))mtext(1,at=j2seq[OND]+15,text=mseq[OND],cex=cx,las=2,adj=1,line=0.5)
      if(s==1)mtext(side=3,yrz[y],line=0.5,cex=cx)
      if(y==1)mtext(side=2,sitez[s],line=0.5,las=2,cex=cx)
      if(y==length(yrz))axis(4,at=c(round(ymax*0.75,2)),las=2,cex.axis=cxa)
    }
  }
  par(mfrow=c(1,1),mar=c(4,4,4,4),oma=c(0,0,0,0))
  form<-formula(bbest)
  tx<-paste(unfun(form),"   AIC =",round(AIC(bbest),1),"   BIC =",round(BIC(bbest),1))
  #mtext(side=3,tx,line=3)
  mtext(side=2,"Site Number",line=3,cex=cx)
  mtext(side=4,"Probability of Grunt Occurrence",line=3,cex=cx)
}
mtext(side=3,"a)",adj=0,cex=cx*1.5,line=3)
dev.off()

#GRUNT RATE
if(FALSE){
  cx<-0.75
  cxa<-1
  lwx<-2
  sigdigs<-1
  #jpeg(file="pred_v_obs_RATE_wk.png",width=6,height=4,units="in",res=600)
  pdf(file="pred_v_obs_RATE_wk.pdf",width=6,height=4)
  if(TRUE){
    clx_fit<-"black"
    #gsub$pred_GRUNTS<-predict(zbest,type='response')
    gsub$pred_GRUNTS<-predict_multimod(zmodz[ztab$mod[ztab$PRED]],type='response')
    msub<-unique(gsub[c("Site","Year")])
    sitez<-unique(subset(marus[order(-marus$LAT),],Site%in%as.character(unique(gsub$Site)))$Site)
    #sitez<-as.character(unique(gsub$Site))
    yrz<-sort(as.character(unique(gsub$Year)))
    xl<-c(282,365)
    d1<-as.Date('2015-01-01')
    d2<-as.Date('2015-12-01')
    dseq<-seq(d1,d2,by="month")
    jseq<-j2seq<-as.numeric(format(dseq,'%j'))
    j2seq[j2seq<100]<-j2seq[j2seq<100]+365
    OND<-c(10:12)
    mseq<-format(dseq,'%b')
    par(mfrow=c(length(sitez),length(yrz)),oma=c(3,3.5,3,4.5),mar=c(0,0,0,0),lend=2)
    for(s in 1:length(sitez)){
      sub<-subset(gsub,Site==sitez[s])
      sub$obs_GRUNTS<-sub$GPH
      ag_obs<-aggregate(obs_GRUNTS~J+MONTH+Year,data=sub,FUN=mean)
      ag_pred<-aggregate(pred_GRUNTS~J+MONTH+Year,data=sub,FUN=mean)
      max_obs<-max(ag_obs$obs_GRUNTS)
      max_pred<-max(ag_pred$pred_GRUNTS)
      ymax<-(max(c(max_obs,max_pred)))
      #ymax<-max_obs
      yl<-c(0,ymax)
      for(y in 1:length(yrz)){
        pred<-subset(gsub,Site==sitez[s]&Year==yrz[y])
        if(nrow(pred)==0){
          plot(1,type='n',axes=FALSE,ylim=yl,xlim=xl)
          rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "lightgray")
          box()
        }
        if(nrow(pred)>1){
          pred$obs_GRUNTS<-as.numeric(pred$GPH)
          ag_obs<-aggregate(obs_GRUNTS~J+MONTH,data=pred,FUN=mean)
          ag_pred<-aggregate(pred_GRUNTS~J+MONTH,data=pred,FUN=mean)
          plot(obs_GRUNTS~J,data=ag_obs[order(ag_obs$J),],type='h',lwd=3,col="gray",xlim=xl,yaxt='n',xaxt='n',ylim=yl)
          lines(pred_GRUNTS~J,data=ag_pred[order(ag_pred$J),],col=alpha(clx_fit,0.5),type='l',lwd=lwx)
        }
        #if(s==length(sitez))axis(1,at=j2seq,labels=mseq)
        #if(s==1)mtext(side=3,yrz[y],line=0.5,cex=cx)
        #if(y==1)mtext(side=2,sitez[s],line=0.5,las=2,cex=cx)
        #if(y==length(yrz))axis(4,at=c(round(ymax*0.75)),las=2)
        if(s==length(sitez))axis(1,at=j2seq,labels=rep("",length(j2seq)),cex.axis=cx)
        if(s==length(sitez))mtext(1,at=j2seq[OND]+15,text=mseq[OND],cex=cx,las=2,adj=1,line=0.5)
        if(s==1)mtext(side=3,yrz[y],line=0.5,cex=cx)
        if(y==1)mtext(side=2,sitez[s],line=0.5,las=2,cex=cx)
        if(y==length(yrz))axis(4,at=c(signif(ymax*0.75,sigdigs)),las=2,cex.axis=cxa)
      }
    }
    par(mfrow=c(1,1),mar=c(4,4,4,4),oma=c(0,0,0,0))
    form<-formula(zfull)
    tx<-paste(unfun(form),"   ",unfun(zform),"   AIC =",round(AIC(zfull),1),"   BIC =",round(BIC(zfull),1))
    #mtext(side=3,tx,line=3,cex=0.85)
    mtext(side=2,"Site Number",line=3,cex=cx)
    mtext(side=4,"Grunts per Hour",line=3,cex=cx)
  }
  mtext(side=3,"b)",adj=0,cex=cx*1.5,line=3)
  dev.off()
}

cx<-0.75
cxa<-1
lwx<-2
lwx_obs<-1.25
sigdigs<-1
#jpeg(file="pred_v_obs_LOGRATE.png",width=6,height=4,units="in",res=600)
pdf(file="pred_v_obs_LOGRATE.pdf",width=6,height=4,colormodel="cmyk")
if(TRUE){
  clx_fit<-"black"
  #gsub$pred_GRUNTS<-predict(zbest,type='response')
  gsub$pred_GRUNTS<-predict_multimod(zbest_mm,weights=zbest_wts,type='response')
  msub<-unique(gsub[c("Site","Year")])
  sitez<-unique(subset(marus[order(-marus$LAT),],Site%in%as.character(unique(gsub$Site)))$Site)
  #sitez<-as.character(unique(gsub$Site))
  yrz<-sort(as.character(unique(gsub$Year)))
  xl<-c(282,365)
  d1<-as.Date('2015-01-01')
  d2<-as.Date('2015-12-01')
  dseq<-seq(d1,d2,by="month")
  jseq<-j2seq<-as.numeric(format(dseq,'%j'))
  j2seq[j2seq<100]<-j2seq[j2seq<100]+365
  OND<-c(10:12)
  mseq<-format(dseq,'%b')
  par(mfrow=c(length(sitez),length(yrz)),oma=c(3,3.5,3,4.5),mar=c(0,0,0,0),lend=2)
  for(s in 1:length(sitez)){
    sub<-subset(gsub,Site==sitez[s])
    sub$obs_GRUNTS<-sub$GPH
    ag_obs<-aggregate(obs_GRUNTS~J+MONTH+Year,data=sub,FUN=mean)
    ag_pred<-aggregate(pred_GRUNTS~J+MONTH+Year,data=sub,FUN=mean)
    max_obs<-max(ag_obs$obs_GRUNTS)
    max_pred<-max(ag_pred$pred_GRUNTS)
    ymax<-log(max(c(max_obs,max_pred)+1))
    #ymax<-max_obs
    yl<-c(0,ymax)
    for(y in 1:length(yrz)){
      pred<-subset(gsub,Site==sitez[s]&Year==yrz[y])
      if(nrow(pred)==0){
        plot(1,type='n',axes=FALSE,ylim=yl,xlim=xl)
        rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = "lightgray")
        box()
      }
      if(nrow(pred)>1){
        pred$obs_GRUNTS<-as.numeric(pred$GPH)
        ag_obs<-aggregate(obs_GRUNTS~J+MONTH,data=pred,FUN=mean)
        ag_pred<-aggregate(pred_GRUNTS~J+MONTH,data=pred,FUN=mean)
        plot(log(obs_GRUNTS+1)~J,data=ag_obs[order(ag_obs$J),],type='h',lwd=lwx_obs,col="gray",xlim=xl,yaxt='n',xaxt='n',ylim=yl)
        lines(log(pred_GRUNTS+1)~J,data=ag_pred[order(ag_pred$J),],col=alpha(clx_fit,0.5),type='l',lwd=lwx)
      }
      #if(s==length(sitez))axis(1,at=j2seq,labels=mseq)
      #if(s==1)mtext(side=3,yrz[y],line=0.5,cex=cx)
      #if(y==1)mtext(side=2,sitez[s],line=0.5,las=2,cex=cx)
      #if(y==length(yrz))axis(4,at=c(round(ymax*0.75)),las=2)
      if(s==length(sitez))axis(1,at=j2seq,labels=rep("",length(j2seq)),cex.axis=cx)
      if(s==length(sitez))mtext(1,at=j2seq[OND]+15,text=mseq[OND],cex=cx,las=2,adj=1,line=0.5)
      if(s==1)mtext(side=3,yrz[y],line=0.5,cex=cx)
      if(y==1)mtext(side=2,sitez[s],line=0.5,las=2,cex=cx)
      if(y==length(yrz))axis(4,at=c(signif(ymax*0.75,sigdigs)),las=2,cex.axis=cxa)
    }
  }
  par(mfrow=c(1,1),mar=c(4,4,4,4),oma=c(0,0,0,0))
  form<-formula(zbest)
  tx<-paste(unfun(form),"   ",unfun(zform),"   AIC =",round(AIC(zbest),1),"   BIC =",round(BIC(zbest),1))
  #mtext(side=3,tx,line=3,cex=0.85)
  mtext(side=2,"Site Number",line=3,cex=cx)
  mtext(side=4,"log(Grunts-per-Hour + 1)",line=3,cex=cx)
}
mtext(side=3,"b)",adj=0,cex=cx*1.5,line=3)
dev.off()


###################
#CIRCULAR VARIABLES FX

#EST MARGINAL MEANS
#MEAN ACROSS ALL YEARS & SITES, BUT AT MIDNIGHT, FULL MOON, NOV23
if(TRUE){

  #DIEL FX
  print("Diel FX")
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=335,MOON=pi,H=0:24,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  #nd$pG<-predict(bbest,newdata=nd,type='response')
  #nd$rG<-predict(zbest,newdata=nd,type='response')
  nd$pG<-predict_multimod(bbest_mm,weights=bbest_wts,newdata=nd,type='response')
  nd$rG<-predict_multimod(zbest_mm,weights=zbest_wts,newdata=nd,type='response')
  emm_h<-summaryBy(cbind(pG,rG)~H,data=nd,FUN=mean,keep.names=TRUE)
  
  #LUNAR FX
  print("Lunar FX")
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=335,MOON=seq(0,2*pi,length=16),H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  #nd$pG<-predict(bbest,newdata=nd,type='response')
  #nd$rG<-predict(zbest,newdata=nd,type='response')
  nd$pG<-predict_multimod(bbest_mm,weights=bbest_wts,newdata=nd,type='response')
  nd$rG<-predict_multimod(zbest_mm,weights=zbest_wts,newdata=nd,type='response')
  emm_l<-summaryBy(cbind(pG,rG)~MOON,data=nd,FUN=mean,keep.names=TRUE) 
  
  #SEASONAL FX - OVERALL
  print("Seasonal FX")
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=275:400,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  #nd$pG<-predict(bbest,newdata=nd,type='response')
  #nd$rG<-predict(zbest,newdata=nd,type='response')
  nd$pG<-predict_multimod(bbest_mm,weights=bbest_wts,newdata=nd,type='response')
  nd$rG<-predict_multimod(zbest_mm,weights=zbest_wts,newdata=nd,type='response')
  emm_j<-summaryBy(cbind(pG,rG)~J,data=nd,FUN=mean,keep.names=TRUE)
  emm_j$edate<-as.Date('2010-12-31')+emm_j$J
  
  #SEASONAL x SITE FX
  print("Seasonal X Site FX")
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=282:365,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  #nd$pG<-predict(bbest,newdata=nd,type='response')
  #nd$rG<-predict(zbest,newdata=nd,type='response')
  nd$pG<-predict_multimod(bbest_mm,weights=bbest_wts,newdata=nd,type='response')
  nd$rG<-predict_multimod(zbest_mm,weights=zbest_wts,newdata=nd,type='response')
  emm_js<-summaryBy(cbind(pG,rG)~J+Site,data=nd,FUN=mean,keep.names=TRUE)
  emm_js$edate<-as.Date('2010-12-31')+emm_js$J
  sitz<-unique(emm_js$Site)
  peakz<-NULL
  for(s in 1:length(sitz)){
    sub<-subset(emm_js,Site==sitz[s])
    pk_pG<-sub$edate[sub$pG==max(sub$pG)]
    pk_rG<-sub$edate[sub$rG==max(sub$rG)]
    df<-data.frame(Site=sitz[s],peak_pG=pk_pG,peak_rg=pk_rG)
    peakz<-rbind(peakz,df)
  }
  
  #SITE FX
  print("Site FX")
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=282:365,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  #nd$pG<-predict(bbest,newdata=nd,type='response')
  #nd$rG<-predict(zbest,newdata=nd,type='response')
  nd$pG<-predict_multimod(bbest_mm,weights=bbest_wts,newdata=nd,type='response')
  nd$rG<-predict_multimod(zbest_mm,weights=zbest_wts,newdata=nd,type='response')
  emm_s<-summaryBy(cbind(pG,rG)~Site,data=nd,FUN=mean,keep.names=TRUE)
  
  #ANNUAL
  print("Annual FX")
  nd<-expand.grid(Y=as.character(unique(gsub$Y)),Site=as.character(unique(gsub$Site)),J=282:365,MOON=pi,H=0,WK=NA,DAY=NA,DEPTH=50)
  nd<-make_circ(nd)
  #nd$pG<-predict(bbest,newdata=nd,type='response')
  #nd$rG<-predict(zbest,newdata=nd,type='response')
  nd$pG<-predict_multimod(bbest_mm,weights=bbest_wts,newdata=nd,type='response')
  nd$rG<-predict_multimod(zbest_mm,weights=zbest_wts,newdata=nd,type='response')
  emm_y<-summaryBy(cbind(pG,rG)~Y,data=nd,FUN=mean,keep.names=TRUE)
  #emm_y<-summaryBy(pG~Y,data=nd,FUN=mean,keep.names=TRUE)
  emm_y$Y<-as.numeric(as.character(emm_y$Y))
  emm_y<-emm_y[order(emm_y$Y),]
  plot(pG~Y,data=emm_y,type='l')
  
  #emm_ys<-summaryBy(cbind(pG,rG)~Y+Site,data=nd,FUN=mean,keep.names=TRUE)
  emm_ys<-summaryBy(pG~Y+Site,data=nd,FUN=mean,keep.names=TRUE)
  emm_ys$Y<-as.numeric(as.character(emm_ys$Y))
  emm_ys<-emm_ys[order(emm_ys$Y),]
  
  sitz<-unique(emm_ys$Site)
  emm_ys$SiteY<-paste(emm_ys$Site,emm_ys$Y,sep="_")
  plot(pG~Y,data=emm_ys,col=Site,type='n')
  for(s in 1:length(sitz)){
    ltx<-ceiling(s/8)
    lines(pG~Y,data=emm_ys,subset=Site==sitz[s],col=alpha(s,0.33),lty=ltx)
    esub<-subset(emm_ys,SiteY%in%gsub$SiteY)
    lines(pG~Y,data=esub,subset=Site==sitz[s],col=s,lwd=2,lty=ltx)
  }
  legend("topleft",legend=sitz,col=1:length(sitz),cex=0.85,lty=ceiling((1:length(sitz))/8),lwd=2)
  
}

#GGPLOT FIGURE of DIEL, LUNAR FX
if(TRUE){
  alf<-0.5
  yfrac<-0.95
  ############

  ###########
  #PRESENCE
  ymn<-min(c(emm_h$pG,emm_l$pG))
  ymx<-max(c(emm_h$pG,emm_l$pG))
  yrange<-ymx-ymn
  ymn<-ymn-(yrange*0.25)
  ymx<-ymx+(yrange*0.25)

  #DIEL PRESENCE
  xmx<-24
  labz_h<-data.frame(H=c(23,5.5,11,16.5),lab=c("Night","","Day",""))
  colz_h<-rep("black",24); colz_h[7:16]<-"white"; colz_h[c(6,17)]<-"darkgray"; 
  pg_circ_h<-ggplot()+
      geom_rect(aes(xmin=0:23,xmax=1:24,ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_h,alf))+
      coord_polar()+geom_line(data=emm_h,aes(x=H,y=pG),lwd=2)+
      ylim(ymn,ymx)+theme_minimal()+
      theme(
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(hjust=0.5,vjust=1)
      ) +
      ggtitle("Grunt Presence")+
      geom_text(data=labz_h, aes(x=H, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
    
  
  #LUNAR PRESENCE
  seq_l<-seq(0,2*pi,length=32)
  crp_l<-colorRampPalette(c("black","white","black"))
  colz_l<-crp_l(length(seq_l)-1)
  labz_l<-data.frame(MOON=c(0,pi/2,pi,pi*1.5),lab=c("New Moon","","Full Moon",""))
  pg_circ_l<-ggplot()+geom_rect(aes(xmin=seq_l[-length(seq_l)],xmax=seq_l[-1],ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_l,alf))+
    coord_polar()+geom_line(data=emm_l,aes(x=MOON,y=pG),lwd=2)+ylim(ymn,ymx)+
    theme_minimal()+
    theme(
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      plot.title = element_text(hjust=0.5,vjust=1)
    ) +
    xlab("Lunar")+
    geom_text(data=labz_l, aes(x=MOON, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
  
  
  ############
  #RATE
  ymn<-min(c(emm_h$rG,emm_l$rG))
  ymx<-max(c(emm_h$rG,emm_l$rG))
  yrange<-ymx-ymn
  ymn<-ymn-(yrange*0.25)
  ymx<-ymx+(yrange*0.25)
  
  #DIEL RATE
  labz_h<-data.frame(H=c(23,5.5,11,16.5),lab=c("Night","","Day",""))
  colz_h<-rep("black",24); colz_h[7:16]<-"white"; colz_h[c(6,17)]<-"darkgray"; 
  rg_circ_h<-ggplot()+
    geom_rect(aes(xmin=0:23,xmax=1:24,ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_h,alf))+
    coord_polar()+geom_line(data=emm_h,aes(H,rG),lwd=2)+ylim(ymn,ymx)+theme_minimal()+
    theme(
      axis.title.y=element_blank(),
      axis.title.x=element_blank(),
      axis.text.x = element_blank(),
      plot.title = element_text(hjust=0.5,vjust=1)
    ) +
    ggtitle("Grunt Rate")+
    geom_text(data=labz_h, aes(x=H, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
  
  #LUNAR RATE
  seq_l<-seq(0,2*pi,length=32)
  crp_l<-colorRampPalette(c("black","white","black"))
  colz_l<-crp_l(length(seq_l)-1)
  labz_l<-data.frame(MOON=c(0,pi/2,pi,pi*1.5),lab=c("New Moon","","Full Moon",""))
  rg_circ_l<-ggplot()+geom_rect(aes(xmin=seq_l[-length(seq_l)],xmax=seq_l[-1],ymin=!!ymn,ymax=!!ymx*yfrac),fill=alpha(colz_l,alf))+
    coord_polar()+geom_line(data=emm_l,aes(x=MOON,y=rG),lwd=2)+ylim(ymn,ymx)+
    theme_minimal()+
    theme(
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      plot.title = element_text(hjust=0.5,vjust=1)
    ) +
    geom_text(data=labz_l, aes(x=MOON, y=!!ymx, label=lab, hjust=0.5), color="black", size=4 ) 
  
  grid.arrange(pg_circ_h,rg_circ_h,pg_circ_l,rg_circ_l,nrow=2)
  
  ht<-5 #HEIGHT OF PLOT IN INCHES
  nr<-2; nc<-2; lmat<-matrix(seq_len(nr*nc),nrow=nr,ncol=nc,byrow=TRUE)
  #ggsave("diel_lunar_fx.jpg",marrangeGrob(list(pg_circ_h,rg_circ_h,pg_circ_l,rg_circ_l),layout_matrix=lmat,top="",padding=unit(0,"line")),width=ht*1,height=ht,dpi=600)
  ggsave("diel_lunar_fx.pdf",marrangeGrob(list(pg_circ_h,rg_circ_h,pg_circ_l,rg_circ_l),layout_matrix=lmat,top="",padding=unit(0,"line")),width=ht*1,height=ht,dpi=600)
  
}
  
  


```

